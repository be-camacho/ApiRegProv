name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install SSH key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.EC2_SSH_KEY }}
        known_hosts: 'just-a-placeholder-so-we-dont-get-errors'

    - name: Connect to EC2 and deploy
      run: |
        ssh -o StrictHostKeyChecking=no -p ${{ secrets.EC2_PORT || 22 }} ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "
          # 1. Actualizar código
          cd /home/ec2-user/ApiRegProv || (git clone https://github.com/be-camacho/ApiRegProv.git /home/ec2-user/ApiRegProv && cd /home/ec2-user/ApiRegProv)
          git pull origin main
          
          # 2. Detener y eliminar contenedores existentes (solo si existen)
          if [ \"$(sudo docker ps -aq)\" ]; then
            sudo docker stop $(sudo docker ps -aq)
            sudo docker rm $(sudo docker ps -aq)
          fi
          
          # 3. Eliminar imágenes existentes (solo si existen)
          if [ \"$(sudo docker images -q apiprovs)\" ]; then
            sudo docker rmi $(sudo docker images -q apiprovs) -f
          fi
          
          # 4. Limpieza de Docker
          sudo docker system prune -f
          
          # 5. Liberar puerto 80 si está en uso
          sudo lsof -ti :80 | xargs -r sudo kill -9 || true
          
          # 6. Reconstruir imagen sin caché
          sudo docker build --no-cache -t apiprovs .
          
          # 7. Ejecutar nuevo contenedor
          sudo docker run -d \
            --name apiprovs_container \
            --restart unless-stopped \
            -p 80:8000 \
            apiprovs
          
          # 8. Verificación
          echo '--- Contenedores activos ---'
          sudo docker ps
          echo '--- Intento de conexión ---'
          curl -I http://localhost:80 || echo 'La aplicación no responde aún'
        "
